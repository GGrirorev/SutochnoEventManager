# Функциональные возможности системы управления событиями аналитики

## 1. Управление событиями

### 1.1 Каталог событий
- Просмотр списка всех событий аналитики с фильтрацией и поиском
- Фильтрация по категории, платформе (WEB, iOS, Android, Backend), статусу внедрения и валидации
- Поиск по названию, действию и описанию события
- Отображение текущей версии и статусов для каждой платформы

### 1.2 Создание событий
- Форма создания нового события с полями:
  - Категория (с автодополнением из существующих)
  - Действие (Event Action)
  - Название (Event Name)
  - Блок/раздел продукта
  - Описание действия
  - Описание значения
  - Платформы (множественный выбор)
  - Свойства события (JSON-структура)
  - Ответственный
  - Заметки
- Автоматическое создание категории при вводе новой
- Автоматическая установка автора события

### 1.3 Редактирование событий
- Редактирование всех полей события
- Автоматическое создание новой версии при изменении ключевых полей:
  - Категория
  - Действие
  - Название
  - Описание значения
  - Свойства
- Обязательное описание изменений при создании новой версии

### 1.4 Удаление событий
- Удаление события со всеми связанными данными (версии, статусы, история, комментарии)
- Атомарное удаление через транзакцию базы данных
- Доступно только для администраторов

## 2. Система версионирования

### 2.1 Версии событий
- Каждое событие начинается с версии v1
- Новая версия создается автоматически при изменении ключевых полей
- Хранение полного снимка состояния события для каждой версии
- Просмотр любой исторической версии через выпадающий список

### 2.2 Независимые статусы версий
- Каждая версия имеет собственные статусы для каждой платформы
- При создании новой версии статусы сбрасываются на "черновик" / "ожидает проверки"
- Старые версии можно редактировать (для параллельной поддержки)

## 3. Статусы платформ

### 3.1 Статус внедрения
- черновик — событие в разработке
- в_разработке — ведется техническая реализация
- внедрено — событие работает в продакшене
- архив — устаревшее событие

### 3.2 Статус валидации
- ожидает_проверки — требуется проверка корректности
- корректно — данные приходят правильно
- ошибка — обнаружены проблемы с данными
- предупреждение — есть замечания

### 3.3 История изменений статусов
- Полная история изменений для каждой платформы
- Фиксация автора и времени каждого изменения
- Опциональный комментарий к изменению

## 4. Управление категориями

- Отдельная таблица для хранения категорий
- Автоматическое создание категории при создании/редактировании события
- Автодополнение при вводе категории в форме
- API для получения списка всех категорий

## 5. Библиотека шаблонов свойств

### 5.1 Управление шаблонами
- Создание переиспользуемых шаблонов свойств
- Поля шаблона: название, тип данных, описание, обязательность, пример
- Редактирование и удаление шаблонов
- Поиск по названию и описанию

### 5.2 Использование шаблонов
- Добавление шаблона к свойствам события одним кликом
- Предотвращение дублирования свойств

## 6. Система пользователей

### 6.1 Роли и права доступа
- **viewer** (Только просмотр) — просмотр событий и свойств
- **developer** (Разработчик) — просмотр + изменение статусов платформ
- **analyst** (Аналитик) — создание/редактирование событий, изменение статусов, комментарии
- **admin** (Администратор) — полный доступ включая управление пользователями и плагинами

### 6.2 Управление пользователями
- Список всех пользователей с фильтрацией по роли
- Создание новых пользователей
- Редактирование роли и данных пользователя
- Деактивация/активация пользователей
- Сброс пароля

## 7. Аутентификация

### 7.1 Сессионная авторизация
- Вход по email и паролю
- Хранение сессий в PostgreSQL
- Хеширование паролей bcrypt

### 7.2 Первоначальная настройка
- Мастер создания первого администратора при пустой базе
- Автоматический вход после создания первого пользователя

### 7.3 Безопасность
- CSRF-защита для всех изменяющих запросов
- Проверка заголовков Origin/Referer
- Требование Content-Type: application/json

## 8. Система комментариев

- Добавление комментариев к событиям
- Отображение автора и времени комментария
- Удаление комментариев (только для администраторов)
- Права: viewer не может комментировать, остальные роли могут

## 9. Импорт из CSV

### 9.1 Формат файла
- Разделитель: точка с запятой (;)
- Кодировка: UTF-8
- Обязательные колонки: Event Category, Event Action

### 9.2 Поддерживаемые колонки
- Платформа
- Блок
- Действие (описание)
- Event Category
- Event Action
- Event Name
- Event Value (описание значения)
- dimension* (свойства)

### 9.3 Режимы импорта
- Создание новых событий
- Обновление существующих (создание новой версии)
- Пропуск дубликатов
- Предварительный просмотр перед импортом

## 10. Плагины

### 10.1 Архитектура
- Модульная система расширений
- Включение/выключение плагинов через интерфейс
- Конфигурация плагинов в JSON

### 10.2 Доступные плагины

#### code-generator
- Генерация кода отслеживания для Matomo
- Поддержка WEB, iOS, Android платформ
- Копирование кода в буфер обмена

#### analytics-chart
- График статистики события за 30 дней
- Интеграция с Matomo API
- Настройка URL API и токена
- Маппинг платформ на idSite
- Серверное кеширование (12 часов)

#### platform-statuses
- Управление статусами внедрения и валидации
- История изменений статусов
- Комментарии к изменениям

#### comments
- Система комментариев к событиям
- Интеграция с правами доступа

#### csv-import
- Массовый импорт событий из CSV
- Обнаружение дубликатов
- Транзакционный импорт

## 11. Дашборд

- Общая статистика: количество событий, платформ, свойств, пользователей
- Распределение событий по статусам внедрения (диаграмма)
- Последние изменения событий
- Быстрый доступ к основным разделам

## 12. API

### 12.1 События
- `GET /api/events` — список событий
- `GET /api/events/:id` — детали события
- `POST /api/events` — создание события
- `PATCH /api/events/:id` — обновление события
- `DELETE /api/events/:id` — удаление события

### 12.2 Версии
- `GET /api/events/:id/versions` — история версий
- `GET /api/events/:id/versions/:version` — конкретная версия

### 12.3 Статусы платформ
- `GET /api/events/:id/platform-statuses` — статусы всех платформ
- `PATCH /api/events/:id/platform-statuses/:platform` — обновление статуса

### 12.4 Категории
- `GET /api/categories` — список категорий
- `POST /api/categories` — создание категории

### 12.5 Шаблоны свойств
- `GET /api/property-templates` — список шаблонов
- `POST /api/property-templates` — создание шаблона
- `PATCH /api/property-templates/:id` — обновление
- `DELETE /api/property-templates/:id` — удаление

### 12.6 Пользователи
- `GET /api/users` — список пользователей
- `POST /api/users` — создание пользователя
- `PATCH /api/users/:id` — обновление
- `DELETE /api/users/:id` — удаление

### 12.7 Комментарии
- `GET /api/events/:id/comments` — комментарии события
- `POST /api/events/:id/comments` — добавление комментария
- `DELETE /api/comments/:id` — удаление комментария

### 12.8 Плагины
- `GET /api/plugins` — список плагинов
- `PATCH /api/plugins/:id` — обновление настроек

### 12.9 Импорт
- `POST /api/events/import/preview` — предпросмотр импорта
- `POST /api/events/import` — выполнение импорта

### 12.10 Аутентификация
- `POST /api/auth/login` — вход
- `POST /api/auth/logout` — выход
- `GET /api/auth/me` — текущий пользователь
- `GET /api/setup/status` — статус первоначальной настройки
- `POST /api/setup` — создание первого администратора

## 13. Технологии

### Frontend
- React 18 + TypeScript
- Wouter (маршрутизация)
- TanStack React Query (состояние сервера)
- shadcn/ui + Radix UI (компоненты)
- Tailwind CSS (стили)
- Recharts (графики)
- react-hook-form + Zod (формы и валидация)

### Backend
- Express.js 5 + TypeScript
- Drizzle ORM + PostgreSQL
- express-session + connect-pg-simple
- bcrypt (хеширование паролей)

### База данных
- PostgreSQL (Neon)
- Таблицы: events, event_versions, event_platform_statuses, event_categories, property_templates, users, comments, plugins, session
